# Дизайн и архитектура `BashTool`

Этот документ описывает внутреннее устройство `dev_tools_mcp/tools/bash_tool.py`, уделяя особое внимание механизму управления shell-сессией.

## Ключевая концепция: Персистентная (Stateful) сессия

`BashTool` использует **единую, долгоживущую shell-сессию**. Это означает, что состояние (текущая рабочая директория, переменные окружения) **сохраняется** между вызовами команд.

1.  **Один процесс:** При первом вызове инструмента запускается один экземпляр `/bin/bash` (или `cmd.exe`), который остается активным для последующих команд.
2.  **Сохранение состояния:** Все команды выполняются в контексте этого единого процесса, что гарантирует персистентность:
    *   **Текущая рабочая директория (CWD):** `cd` изменяет директорию для всех будущих команд в сессии.
    *   **Переменные окружения:** `export VAR=...` делает переменную доступной для всех последующих команд.
    *   **Shell-функции и алиасы:** Сохраняются до перезапуска сессии.

## Механизм выполнения команд: Техника "Стража" (Sentinel)

Основная сложность в управлении долгоживущим процессом — определить, когда именно завершилась команда и какой у нее код возврата. Эта проблема решена с помощью уникальной строки-маркера, или "стража".

1.  **Формирование команды:** К пользовательской команде (например, `ls -l`) через точку с запятой добавляется команда `echo`, которая выводит "стража" и код возврата. В `stdin` процесса отправляется единая строка:
    ```bash
    ls -l; echo ",,,,bash-command-exit-$?-banner,,,,"
    ```
    Здесь `$?` — это код возврата последней выполненной команды (`ls -l`). Такая простая конструкция гарантирует сохранение состояния и избегает проблем с сабшеллами или зависаниями.

2.  **Асинхронное чтение вывода:**
    *   Скрипт не может просто ждать `EOF` на `stdout`, так как shell-процесс не закрывает этот поток.
    *   Вместо этого он асинхронно и циклически читает данные напрямую из внутреннего буфера `stdout` (`process.stdout._buffer`).
    *   Чтение продолжается до тех пор, пока в буфере не будет обнаружена строка-"страж".

3.  **Парсинг результата:**
    *   Все, что находится в буфере *до* "стража", является выводом (`stdout`) команды.
    *   Сам "страж" парсится для извлечения кода возврата.
    *   После каждого выполнения буферы `stdout` и `stderr` принудительно очищаются, чтобы избежать смешивания выводов от разных команд.

## Управление жизненным циклом сессии

*   **Запуск:** Сессия создается и запускается при первом вызове инструмента. На Unix-системах используется `os.setsid` для создания новой группы процессов, что позволяет надежно завершить shell и все его дочерние процессы.
*   **Завершение:** Метод `stop()` терминирует процесс.
*   **Перезапуск:** Инструмент принимает параметр `restart=True`, который уничтожает текущую сессию и создает новую, полностью чистую. Это единственный способ сбросить состояние сессии.
*   **Таймаут:** Реализован таймаут (120 секунд). Если команда выполняется дольше, сессия блокируется и требует перезапуска.

## Заключение

`BashTool` представляет собой продуманную систему для эмуляции интерактивной работы с терминалом. Он обеспечивает сохранение состояния и надежное управление выполнением команд через асинхронные механизмы и технику "стража", что делает его мощным инструментом для выполнения сложных последовательностей команд.
