# Дизайн и архитектура `BashTool`

Этот документ описывает внутреннее устройство `dev_tools_mcp/tools/bash_tool.py`, уделяя особое внимание механизму управления shell-сессией.

## Ключевая концепция: Персистентная (Stateful) сессия

В отличие от примитивных реализаций, которые создают новый shell-процесс для каждой команды, `BashTool` использует **единую, долгоживущую сессию**.

1.  **Один процесс:** При первом вызове запускается один экземпляр `/bin/bash` (или `cmd.exe` на Windows) с помощью `asyncio.create_subprocess_shell`.
2.  **Сохранение состояния:** Все последующие команды выполняются в контексте этого же процесса. Это означает, что сессия сохраняет состояние:
    *   **Текущая рабочая директория (CWD):** Команда `cd` изменяет директорию для всех последующих команд.
    *   **Переменные окружения:** Экспортированные переменные (`export VAR=...`) доступны на протяжении всей сессии.
    *   **Shell-функции и алиасы:** Определенные пользователем функции и алиасы сохраняются до завершения сессии.

## Механизм выполнения команд: Техника "Стража" (Sentinel)

Основная сложность в управлении долгоживущим процессом — определить, когда именно завершилась команда и какой у нее код возврата. Эта проблема решена с помощью уникальной строки-маркера, или "стража".

1.  **Формирование команды:** Пользовательская команда (например, `ls -l`) оборачивается в конструкцию, которая также выводит "стража" и код возврата. В `stdin` процесса отправляется примерно следующее:
    ```bash
    (
    ls -l
    ); echo ",,,,bash-command-exit-$?-banner,,,,"
    ```
    Здесь `$?` — это код возврата последней выполненной команды (`ls -l`).

2.  **Асинхронное чтение вывода:**
    *   Скрипт не может просто ждать `EOF` на `stdout`, так как shell-процесс не закрывает этот поток.
    *   Вместо этого он асинхронно и циклически читает данные напрямую из внутреннего буфера `stdout` (`process.stdout._buffer`).
    *   Чтение продолжается до тех пор, пока в буфере не будет обнаружена строка-"страж".

3.  **Парсинг результата:**
    *   Все, что находится в буфере *до* "стража", является выводом (`stdout`) команды.
    *   Сам "страж" парсится для извлечения кода возврата.
    *   После каждого выполнения буферы `stdout` и `stderr` принудительно очищаются, чтобы избежать смешивания выводов от разных команд.

## Управление жизненным циклом сессии

*   **Запуск:** Сессия создается и запускается при первом вызове инструмента. На Unix-системах используется `os.setsid` для создания новой группы процессов, что позволяет надежно завершить shell и все его дочерние процессы.
*   **Завершение:** Метод `stop()` терминирует процесс.
*   **Перезапуск:** Инструмент принимает параметр `restart=True`, который уничтожает текущую сессию и создает новую, полностью чистую. Это единственный способ сбросить состояние сессии.
*   **Таймаут:** Реализован таймаут (120 секунд). Если команда выполняется дольше, сессия блокируется и требует перезапуска.

## Заключение

`BashTool` представляет собой продуманную систему для эмуляции интерактивной работы с терминалом. Он обеспечивает сохранение состояния и надежное управление выполнением команд через асинхронные механизмы и технику "стража", что делает его мощным инструментом для выполнения сложных последовательностей команд.
