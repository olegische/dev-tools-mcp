# Проектирование MCP-сервера для `coding_tools_mcp`

---

### 1. Введение

Этот документ описывает проектирование и архитектуру MCP-сервера, который будет предоставлять основные функциональные возможности проекта `coding_tools_mcp` в качестве инструментов для внешних агентов. Цель состоит в том, чтобы позволить другим системам использовать мощные возможности `TraeAgent` для выполнения задач программной инженерии, таких как выполнение команд, редактирование кода, поиск по кодовой базе и работа с Git.

Анализ проекта, основанный на `docs/project_breakdown.md`, показал, что несколько основных инструментов и функций `TraeAgent` являются идеальными кандидатами для выноса через MCP-интерфейс. Инструменты, связанные с внутренним процессом мышления агента (`sequential_thinking`, `task_done`), а также функции для наблюдаемости (`LakeView`, `TrajectoryRecorder`), останутся внутренними.

### 2. Архитектура сервера

Сервер будет построен с использованием библиотеки `FastMCP`, следуя паттерну, продемонстрированному в `docs/context/server.py`. Он будет представлять собой асинхронное приложение на FastAPI/Starlette, где каждый предоставляемый инструмент будет реализован как асинхронная функция, обернутая декоратором `@mcp_app.tool()`.

Сервер будет инкапсулировать логику для:
- Инициализации необходимых компонентов `coding_tools_mcp`.
- Вызова соответствующих классов инструментов (`BashTool`, `TextEditorTool` и т.д.).
- Обработки входных параметров и возвращения результатов в стандартизированном формате.

### 3. Предоставляемые инструменты (Tools)

Следующие инструменты будут реализованы и предоставлены MCP-сервером.

#### 3.1. `bash`

*   **Описание**: Предоставляет возможность выполнять произвольные shell-команды в персистентной сессии. Это позволяет внешнему агенту взаимодействовать с операционной системой, файловой системой, запускать тесты, устанавливать зависимости и выполнять другие системные операции.
*   **Основано на**: `coding_tools_mcp/tools/bash_tool.py`.
*   **Параметры**:
    *   `command` (string, required): Команда для выполнения.
    *   `restart` (boolean, optional): Флаг для перезапуска сессии bash.
*   **Возвращает**: Стандартный вывод (`stdout`), стандартную ошибку (`stderr`) и код возврата (`exit_code`) выполненной команды.

#### 3.2. `file_editor`

*   **Описание**: Мощный инструмент для манипуляции файлами. Он объединяет несколько операций для работы с текстовыми файлами и директориями.
*   **Основано на**: `coding_tools_mcp/tools/edit_tool.py` (внутреннее имя `str_replace_based_edit_tool`).
*   **Параметры**:
    *   `operation` (enum, required): Тип операции. Возможные значения: `view`, `create`, `replace`, `insert`.
    *   `path` (string, required): Абсолютный путь к файлу или директории.
    *   `content` (string, optional): Содержимое для операции `create` или `insert`.
    *   `old_string` (string, optional): Строка для поиска при операции `replace`. Должна быть уникальной в файле.
    *   `new_string` (string, optional): Строка для замены при операции `replace`.
    *   `line_number` (integer, optional): Номер строки для операции `insert`.
*   **Возвращает**: Результат операции. Для `view` — содержимое файла/директории. Для `create`, `replace`, `insert` — сообщение об успехе и фрагмент измененного кода для контекста.

#### 3.3. `json_editor`

*   **Описание**: Специализированный инструмент для точного редактирования JSON-файлов с использованием выражений JSONPath.
*   **Основано на**: `coding_tools_mcp/tools/json_edit_tool.py`.
*   **Параметры**:
    *   `operation` (enum, required): Тип операции: `view`, `set`, `add`, `remove`.
    *   `file_path` (string, required): Абсолютный путь к JSON-файлу.
    *   `json_path` (string, required): Выражение JSONPath для указания целевого элемента.
    *   `value` (any, optional): JSON-совместимое значение для операций `set` и `add`.
*   **Возвращает**: Результат операции. Для `view` — запрошенные данные. Для `set`, `add`, `remove` — сообщение об успехе.

#### 3.4. `code_search`

*   **Описание**: Инструмент для интеллектуального поиска по кодовой базе с использованием Code Knowledge Graph (CKG). Позволяет находить определения функций, классов и методов.
*   **Основано на**: `coding_tools_mcp/tools/ckg_tool.py`.
*   **Параметры**:
    *   `command` (enum, required): Тип поиска: `search_function`, `search_class`, `search_class_method`.
    *   `path` (string, required): Абсолютный путь к корневой директории кодовой базы.
    *   `identifier` (string, required): Имя (идентификатор) функции, класса или метода для поиска.
    *   `print_body` (boolean, optional): Включать ли тело найденного элемента в результат.
*   **Возвращает**: Список найденных совпадений, включая путь к файлу, номер строки и, опционально, тело кода.

#### 3.5. `git_diff`

*   **Описание**: Инструмент для получения изменений в Git-репозитории. Позволяет увидеть текущие незакоммиченные изменения или изменения относительно определенного коммита.
*   **Основано на**: Логика метода `get_git_diff` из `coding_tools_mcp/agent/trae_agent.py`.
*   **Параметры**:
    *   `base_commit` (string, optional): Хэш коммита, относительно которого нужно показать изменения. Если не указан, будут показаны текущие незакоммиченные изменения (`git diff HEAD`).
    *   `path` (string, required): Абсолютный путь к Git-репозиторию.
*   **Возвращает**: Строку с результатом выполнения команды `git diff`.

#### 3.6. `sequential_thinking`

*   **Описание**: Мета-инструмент, позволяющий внешнему агенту структурировать и передавать сложные, многоэтапные рассуждения. Вместо того чтобы выполнять прямое действие, агент может использовать этот инструмент для записи своих мыслей, гипотез и планов. Это может быть полезно для отладки или для того, чтобы человек-оператор мог следить за логикой агента.
*   **Основано на**: `coding_tools_mcp/tools/sequential_thinking_tool.py`.
*   **Параметры**:
    *   `thought` (string, required): Текст мысли или шага рассуждения.
    *   `thought_number` (integer, required): Порядковый номер мысли в последовательности.
    *   `total_thoughts` (integer, required): Общее предполагаемое количество мыслей в последовательности.
    *   ... и другие опциональные параметры для ветвления и ревизии мыслей.
*   **Возвращает**: Сообщение, подтверждающее, что мысль была записана, и текущее состояние истории мыслей.

#### 3.7. `task_done`

*   **Описание**: Сигнальный инструмент, который внешний агент вызывает для обозначения полного завершения своей задачи. Это позволяет системе, управляющей `TraeAgent` как сервисом, знать, когда можно завершать сессию и подводить итоги.
*   **Основано на**: `coding_tools_mcp/tools/task_done_tool.py`.
*   **Параметры**: Нет.
*   **Возвращает**: Простое подтверждение: "Task done.".

### 4. Анализ `trae_agent`

Анализ `trae_agent.py` показал, что сам агент обладает рядом охуенных, но *внутренних* фич, которые делают его эффективным. Ключевая из них — это способность интегрироваться с MCP-серверами (`initialise_mcp`, `discover_mcp_tools`). Это означает, что `TraeAgent` спроектирован как расширяемая система, способная потреблять внешние инструменты.

Наша задача — не переписать `TraeAgent`, а предоставить его *возможности* другим агентам. Поэтому мы не выносим наружу его внутреннюю логику управления задачами или системные промпты. Вместо этого мы берем его "руки" — его инструменты — и делаем их доступными для других.

Функция `get_git_diff` является исключением. Это не формальный "инструмент", а метод класса. Однако его функциональность настолько полезна и атомарна, что ее следует обернуть в полноценный инструмент `git_diff` на нашем MCP-сервере.

### 5. Заключение

Предлагаемый MCP-сервер превратит `coding_tools_mcp` из монолитного агента в мощный, переиспользуемый бэкенд для решения задач программной инженерии. Вынося наружу ключевые инструменты (`bash`, `file_editor`, `json_editor`, `code_search`, `git_diff`), мы создаем сервис, который может быть интегрирован в более крупные и сложные системы автоматизации, позволяя другим агентам делегировать ему низкоуровневые, но критически важные задачи по работе с кодом и окружением.
